name: Simple CI/CD - deploy branch

on:
  push:
    branches: ["deploy"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      DOCKER_REGISTRY: ghcr.io
      OWNER: ${{ github.repository_owner }}
      TAG: ${{ github.sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Ensure .dockerignore prevents env leak
        run: |
          # Add .env and other entries to dockerignore if missing
          for p in gateway services/payment-service services/property-service services/user-service; do
            if [ -d "$p" ]; then
              file="$p/.dockerignore"
              touch "$file"
              grep -q -E '^(\.env|node_modules|dist)$' "$file" || {
                printf "\n# generated by CI: keep secrets out of image\n.env\nnode_modules\ndist\n" >> "$file"
              }
            fi
          done

      - name: Create .env files from repo secrets (if available)
        shell: bash
        run: |
          # Write env contents for each service from repository secrets (you created these)
          # If a secret is empty/unset this command will still run but file will be empty.
          echo "Creating service .env files..."
          if [[ -n "${{ secrets.PRPPENU_GATEWAY_ENV }}" ]]; then
            echo "${{ secrets.PRPPENU_GATEWAY_ENV }}" > gateway/.env
          fi
          if [[ -n "${{ secrets.PRPPENU_PAYMENT_ENV }}" ]]; then
            echo "${{ secrets.PRPPENU_PAYMENT_ENV }}" > services/payment-service/.env
          fi
          if [[ -n "${{ secrets.PRPPENU_PROPERTY_ENV }}" ]]; then
            echo "${{ secrets.PRPPENU_PROPERTY_ENV }}" > services/property-service/.env
          fi
          if [[ -n "${{ secrets.PRPPENU_USER_ENV }}" ]]; then
            echo "${{ secrets.PRPPENU_USER_ENV }}" > services/user-service/.env
          fi
          echo "Done."

      - name: Install root workspace dependencies
        run: npm ci

      - name: Build all backend services
        run: npm run build:backend

      - name: Log into GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker images (gateway + services)
        shell: bash
        run: |
          set -e
          services=(
            "gateway:gateway"
            "services/payment-service:payment-service"
            "services/property-service:property-service"
            "services/user-service:user-service"
          )

          for entry in "${services[@]}"; do
            path="${entry%%:*}"
            image="${entry##*:}"
            echo "Building $image from $path ..."

            # require a Dockerfile in each service path
            if [ ! -f "${path}/Dockerfile" ]; then
              echo "ERROR: Dockerfile not found at ${path}/Dockerfile"
              exit 1
            fi

            docker build -f "${path}/Dockerfile" "${path}" \
              --build-arg NODE_ENV=production \
              -t "${{ env.DOCKER_REGISTRY }}/${{ env.OWNER }}/${image}:${{ env.TAG }}" \
              -t "${{ env.DOCKER_REGISTRY }}/${{ env.OWNER }}/${image}:latest-deploy"

            docker push "${{ env.DOCKER_REGISTRY }}/${{ env.OWNER }}/${image}:${{ env.TAG }}"
            docker push "${{ env.DOCKER_REGISTRY }}/${{ env.OWNER }}/${image}:latest-deploy"
          done

      - name: Optional: Deploy to Kubernetes (if KUBE_CONFIG_DATA is set)
        if: ${{ secrets.KUBE_CONFIG_DATA != '' }}
        env:
          KUBECONFIG_B64: ${{ secrets.KUBE_CONFIG_DATA }}
          OWNER: ${{ env.OWNER }}
          TAG: ${{ env.TAG }}
        run: |
          set -e
          echo "$KUBECONFIG_B64" | base64 --decode > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig

          # Example: expect manifests at k8s/gateway.yaml etc. with __IMAGE_PLACEHOLDER__ inside
          for svc in gateway payment-service property-service user-service; do
            manifest="k8s/${svc}.yaml"
            image="${{ env.DOCKER_REGISTRY }}/${{ env.OWNER }}/${svc}:${{ env.TAG }}"
            if [ -f "$manifest" ]; then
              echo "Applying $manifest with image $image"
              sed "s|__IMAGE_PLACEHOLDER__|${image}|g" "$manifest" | kubectl apply -f -
            else
              echo "No manifest for $svc at $manifest â€” skipping"
            fi
          done
